---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# COMET

<!-- badges: start -->
<!-- badges: end -->

The goal of COMET is to simulate provide an open source framework to simulate the United States Lung Allocation System

## Installation

You can install the development version of COMET like so:

```{r, include=FALSE}
library(COMET)
```


```{r, eval=FALSE}
# install.packages("devtools")
devtools::install_github("ClevelandClinicQHS/COMET")
```

## Basic example

```{r example, cache=TRUE}
library(COMET)
## basic example code
## Simulates under LAS rules
r1 <- run_simulation(days = 400, can_start = 1000,
                     match_alg = match_las, wl_model = "LAS15", post_tx_model = "LAS15",
                     wl_weight = 2, post_tx_weight = 1, wl_cap = 365, post_tx_cap = 365, seed = 26638)

## Simulates the CAS rules
r2 <- run_simulation(days = 400, can_start = 1000,
                     match_alg = match_cas, wl_model = "CAS23", post_tx_model = "CAS23",
                     wl_weight = 0.25, post_tx_weight = 0.25, wl_cap = 365, post_tx_cap = 1825,
                     bio_weight = .15, pld_weight = 0.05, peds_weight = 0.2, efficiency_weight = 0.1, seed = 26638)

## You can mix and match systems, change weights
## for example simulate the LAS using the CAS models
# r3 <- run_simulation(days = 400, can_start = 1000,
#                      match_alg = match_las, wl_model = "CAS23", post_tx_model = "CAS23",
#                      wl_weight = 2, post_tx_weight = 1, wl_cap = 365, post_tx_cap = 365, seed = 26638)
# 
# 
# 
# ## or maybe you want to test simulate what would happen if waitlist mortality was weighted the same as post-transplant under the LAS
# r4 <- run_simulation(days = 400, can_start = 1000,
#                      match_alg = match_las, wl_model = "CAS23", post_tx_model = "CAS23",
#                      wl_weight = 1, post_tx_weight = 1, wl_cap = 365, post_tx_cap = 365, seed = 26638)


```

## A comparison of the models
```{r comparison of simualtions}
# see how many were transplanted, donor count, waitlist deaths
eval_simulation(r1)

eval_simulation(r2)

## See results by diagnosis group
eval_simulation(r1, group = dx_grp)
eval_simulation(r2, group = dx_grp)
```


## A further demonstration to show what is going on behind the scenes
### Generates candidates and donors
```{r}
## One major advantage of the simulation is the use of synthetic candidates and donors
## All of these rely on bayesian hyperparametric distributions for the candidate and donor characteristics
set.seed(26638)
syn_cands <- gen_and_spawn_candidates(days = 10)
syn_dons <- gen_and_spawn_donors(days = 10)
```

## the function iterate runs each day, if you specify a list
For this scenario I'm going to add `r max(r2$all_candidates$listing_day)` days the listing and recovery day to `syn_cands` and `syn_donors` and also make sure the candidate and donor ids do not conflict. I'm going to continue the results from CAS simulation (`r2`). The notation for the LAS simulation (`r1`) is very similar.
```{r}
syn_cands <- dplyr::mutate(syn_cands,
                           listing_day = listing_day + max(r2$all_candidates$listing_day),
                           c_id = c_id + max(r2$all_candidates$c_id))

syn_dons <- dplyr::mutate(syn_dons,
                          recovery_day = recovery_day + max(r2$all_candidates$listing_day),
                          d_id = d_id + max(r2$all_donors$d_id))

r2cc <- r2$current_candidates

l <- list("current_candidates" = r2cc,
          "recipient_database" = r2$recipient_database,
          "waitlist_death_database" = r2$waitlist_death_database,
          "post_tx_death_database" = r2$post_tx_death_database,
          "non_used_donors" = r2$non_used_donors)

l_1 <- iteration(401, syn_cands, syn_dons, include_matches = FALSE, updated_list = l, match_alg = match_cas,
                 wl_model = "CAS23", post_tx_model = "CAS23", wl_weight = 0.25, post_tx_weight = 0.25,
                 wl_cap = 365, post_tx_cap = 1825, bio_weight = .15, pld_weight = 0.05,
                 peds_weight = 0.2, efficiency_weight = 0.1)

l_2 <- iteration(402, syn_cands, syn_dons, include_matches = FALSE, updated_list = l_1, match_alg = match_cas,
                 wl_model = "CAS23", post_tx_model = "CAS23", wl_weight = 0.25, post_tx_weight = 0.25,
                 wl_cap = 365, post_tx_cap = 1825, bio_weight = .15, pld_weight = 0.05,
                 peds_weight = 0.2, efficiency_weight = 0.1)

```

This will run ten days sequentially
```{r}
l_i <- l
for(i in 401:410){
  l_i <- iteration(i,
                   syn_cands, syn_dons, include_matches = FALSE, updated_list = l_i,
                   match_alg = match_cas,  wl_model = "CAS23", post_tx_model = "CAS23",
                   wl_weight = 0.25, post_tx_weight = 0.25, wl_cap = 365, post_tx_cap = 1825,
                   bio_weight = .15, pld_weight = 0.05, peds_weight = 0.2, efficiency_weight = 0.1)
  
}
```


## within each day
`update_patients` is the function that runs each day, it will output a list of those that died, were removed for other reasons if on the waiting list, those that a still alive and updated characteristics. Currently the only characteristic is that updated is the candidate's age, but it is made to be flexible to adjust any clinical characteristic i.e. ($\textrm{pCO}_2$,$\textrm{FEV}_1$, bilirubin, etc.)

`identify_deaths` returns a dataset of those who died either on the waiting list or post-transplant

`identify_removals` returns a dataset of those who were removed on the waiting list

If you are wondering what "CAS23r", the baseline hazard is for the CAS23 models 'recalibrated' after research and initial simulations runs showed that the CAS23 model did not accurately simulate waitlist and post-transplant deaths.
```{r}
update_patients(patients = r2cc, model = "CAS23r", 
                elapsed_time = days_on_waitlist, pre_tx = TRUE, cap = 365, date = 401)

## which includes

identify_deaths(patients = r2cc, model = "CAS23r",
                elapsed_time = days_on_waitlist, pre_tx = TRUE, cap = 365, date = 401)

identify_removals(patients = r2cc, elapsed_time = days_on_waitlist, cap = 2365)

## post-transplant deaths
update_patients(r2$recipient_database,  model = "CAS23r", 
                elapsed_time = days_after_tx, pre_tx = FALSE, cap = 1825, date = 401)

```

## Matching
For screening, matching, and donor acceptance, all of that is bundled in two main functions \code{match_cas} and \code{match_las}.
```{r}
##
dons_401 <- dplyr::filter(syn_dons, recovery_day == 401)

mtc <- match_cas(cands = r2cc, dons = dons_401, wl_model = "CAS23", post_tx_model = "CAS23", wl_weight = 0.25,
                 post_tx_weight = 0.25, wl_cap = 365, post_tx_cap = 1825, bio_weight = .15,
                 pld_weight = 0.05, peds_weight = 0.2, efficiency_weight = 0.1)

mtc 

```

An in depth look at screening. One can create custom screen functions or screen on whatever criteria one would like.
They are designed to input candidates and donors respectively.
```{r}

## within matching
## there is screening
## Screening is done for height, blood type, organ count,
hm1 <- height_screen(cands = r2cc, dons = dons_401)
hm1
## returns if compabitible for single, double transplant, if a double transplant they will match for double lung
am1 <- abo_screen(cands = r2cc, dons = dons_401)
am1
## returns abo_exact abo compatible organs since that is a tie breaker in the LAS

## Ensure double with double, singles may take a double if only is assigned or either can
cm1 <- count_screen(cands = r2cc, dons = dons_401)
cm1

## Distance calculation 
lm1 <- dist_calc(cands = r2cc, dons = dons_401)
lm1


```

In our simulation you will see to rankings `ov_rank` which stands for overall ranking and `offer_rank`. `ov_rank` is the candidates rank with respective to all candidates on that day based on their LAS/CAS score, regardless of donor/offer. `offer_rank` is the rank of the candidate with respect to all compatible candidates to the given donor. The CAS score that does not change called the "sub_cas" calculcates the `ov_rank`

```{r}
## ranking
lr1 <- calculate_sub_cas(r2cc, wl_model = "CAS23", post_tx_model = "CAS23", wl_weight = 0.25,
                         post_tx_weight = 0.25, wl_cap = 365, post_tx_cap = 1825, bio_weight = .15,
                         pld_weight = 0.05, peds_weight = 0.2)

lr1
```

This 
```{r}

## matching and offering rank
## Pra screening is not currently implemented,
## you'll notice that if you run the function it returns a combination of every candidate and donor
offs <- cas_offer_rank(hm1, am1, cm1, lm1, overall_ranking = lr1, efficiency_weight = 0.1)
offs

## This function is here to model acceptance probability
## Others are happy to glad their own
set.seed(26638)
acceptance_prob(offs, dons = dons_401, cands = r2cc)

## transplant_recipeints
transplant_candidates(matches = mtc)
```

## Other tips and tricks

You will notice a `pra_screen` function. This is a place-holder for now that returns a grid of every candidate and donor pairing. Future implementation will incorporate PRA screening criteria.
```{r}
pra_screen(cands = r2cc, dons = dons_401)
```

If you want to return the matches along with the simulated output. All one has to do in the `run_simulation` or `iteration` function is set `include_matches = TRUE`. The output can be seen below is a nested tibble with a vector of donor ids (`d_id`) that are ranked in order for the subsequent offer, called `all_matches`
```{r}
l_1m <- iteration(401, syn_cands, syn_dons, include_matches = TRUE, updated_list = l, match_alg = match_cas,
                 wl_model = "CAS23", post_tx_model = "CAS23", wl_weight = 0.25, post_tx_weight = 0.25,
                 wl_cap = 365, post_tx_cap = 1825, bio_weight = .15, pld_weight = 0.05,
                 peds_weight = 0.2, efficiency_weight = 0.1)

l_1m$all_matches
```

```{r}
COMET::
```


```{r}
## screening
# cas_offer_rank(hm1, am1, cm1, lm1, overall_ranking = lr1)
# 
# ## calculating LAS/CAS scores
# calculate_las(syn_cands, wl_model = "LAS15", post_tx_model = "LAS15", wl_cap = 365, post_tx_cap = 365, wl_weight = 2, post_tx_weight = 1)
# calculate_sub_cas(syn_cands, wl_model = "LAS15", post_tx_model = "LAS15", wl_cap = 365, post_tx_cap = 365, wl_weight = 0.25,
#                   post_tx_weight = 0.25, bio_weight = .15, peds_weight = .2, pld_weight = 0.05)
# 
# ## One may know that CAS biological component is actually 3 of them. one for height, cpra, and blood type.
# ## Can instead specify these weights
# calculate_sub_cas(syn_cands, wl_model = "LAS15", post_tx_model = "LAS15", wl_cap = 365, post_tx_cap = 365, wl_weight = 0.25,
#                   post_tx_weight = 0.25, bio_weight = NA, peds_weight = .2, pld_weight = 0.05,
#                   abo_weight = 0.10, height_weight = 0.05, cpra_weight = 0)
# 
# ## updating patients
# set.seed(266388)
# update_patients(syn_cands, model = "CAS23", elapsed_time = days_on_waitlist, pre_tx = TRUE, cap = 365, date = 11)
# 
# 
# 
# 
# 
# ## transplanting
# # set.seed(367473)
# 
# mz <- match_las(syn_cands, syn_dons, wl_model = "LAS15", post_tx_model = "LAS15", 
#                 wl_cap = 365, post_tx_cap = 365, wl_weight = 2, post_tx_weight = 1)
# mz
# 
# transplant_candidates(mz, rec_ids = NA, max_offer = NA)
## post-transplant
```

## A few helpful tips
```{r}
concat2(r1)

## To grab who was on the waitlist on a specific day
spec_day(r1, day = 300)


```

